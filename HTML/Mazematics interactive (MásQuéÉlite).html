<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Mazematics — Keep Talking and Nobody Explodes Module</title>
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/ktane-utils.js"></script>
    <style>
        @keyframes glow-in-the-dark {
            8%{color:orange;}
            16%{color:yellow;}
            25%{color:chartreuse;}
            33%{color:green;}
            41%{color:springgreen;}
            50%{color:cyan;}
            58%{color:dodgerblue;}
            66%{color:blue;}
            75%{color:purple;}
            83%{color:violet;}
            91%{color:magenta;}
            100%{color:red;}
        }
        td { padding: 1vh }
        td svg {
            padding: 0;
            text-align: center;
            font-size: 3em;
            user-select: none;
            fill: transparent;
            stroke: black;
            stroke-width: 3.5;
            margin-top: 5px;
        }
        #inputs {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            row-gap: 15px;
            margin-left: -20px;
            padding-top: 20px;
        }
            #input-row {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }
        input {
            width: 25%;
            text-align: center;
        }
        .pair {
            display: inline-flex;
            justify-content: space-evenly;
        }
            .small {
                transform: scale(0.4);
                stroke-width: 5px;
            }
            .small-star {
                transform: scale(0.45);
                stroke-width: 4px;
            }
            .small-diamond {
                stroke-width: 5px;
            }
        button {
            background-color: #c0c0c0;
            font-family: "Special Elite";
            font-size: 20px;
            font-weight: bold;
            padding: 10px 10px 0px 10px;
            border: none;
            border-bottom: 3px black dashed;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .smallSVG {
            width: 24px;
            height: 24px;
        }
        .smallSVG svg {
            fill: transparent;
            stroke: black;
            stroke-width: 3.5;
            width: 100%;
        }
        path { stroke-width: 2.5 }
        svg text {
            stroke-width: 0;
            fill: black;
            text-anchor: middle;
            transform: translate(30px, 45px);
        }
        .dark svg path, .dark svg rect, .dark svg polygon, .dark svg circle {
            stroke: #DDD
        }
        .dark svg text { fill: #DDD }
        .dark input {
            background-color: #444;
            color: #DDD;
            border: none;
        }
        .dark a { animation: glow-in-the-dark 8s linear 0s infinite; }
        .page {
            background-repeat: repeat-y;
            background-position: top;
        }
    </style>
</head>
<body class="dark">
    <div class="section">
        <div class="page page-bg-05">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Mazematics</span>
            </div>
            <div class="page-content">
            <img src="img/Component/Mazematics.svg" class="diagram">
            <h2>On the Subject of Mazematics</h2>
            <p class="flavour-text">Which number was star again? Bruh.</p>
            <p style="margin-top:15px">See the <a href='Mazematics.html'>original manual</a> for instructions.</p>
            <div id="inputs">
                <div id="button-row"><button onclick="resetAll()">Reset</button></div>
                <div id="input-row">
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><circle  class="small" cx="30" cy="28" r="25" />                                                                            </svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><rect    class="small-diamond" x="11" y="11" width="35" height="35" transform="rotate(45,12,12) scale(0.4)"/>               </svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><polygon class="small" points="30,54 5,10 55,10" transform="rotate(180)"/>                                                  </svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><path    d="M0 20 v-20 h20 a10,10 0 0,1 0,20 a10,10 0 0,1 -20,0 z" transform="rotate(225,12,12) translate(5,5) scale(0.6)"/></svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><polygon class="small" points="30 5,50 17,50 43,30 53,10 43,10 17"/>                                                        </svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><rect    class="small" x="6" y="6" width="48" height="47"/>                                                                 </svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><polygon class="small-star" points="30 5,35 20,50 20,38 30,44 45,30 35,16 45,22 30,10 20,25 20"/>                           </svg></div><input/></div>
                    <div class="pair"><div class="smallSVG"><svg viewBox="0 0 24 24"><polygon class="small" points="30 6,5 50,55 50"/>                                                                           </svg></div><input/></div>
                </div>
            </div>
            <h3>The Maze</h3>
            <svg id="shapes">
                <defs>
                    <circle  id="circle" cx="30" cy="28" r="25" />
                    <rect    id="diamond" x="11" y="11" width="35" height="35" transform="rotate(45, 30, 30)"/>
                    <polygon id="triangle" points="30 6,5 50,55 50" transform="rotate(180, 30, 29)"/>
                    <path    id="heart" d="M0 20 v-20 h20 a10,10 0 0,1 0,20 a10,10 0 0,1 -20,0 z" transform="rotate(225,30,30) translate(16,16) scale(1.5)"/>
                    <polygon id="hexagon" points="30 5,50 17,50 43,30 53,10 43,10 17"/>
                    <rect    id="square" x="6" y="6" width="48" height="47"/>
                    <polygon id="star" points="30 5,35 20,50 20,38 30,44 45,30 35,16 45,22 30,10 20,25 20" transform="scale(1.2) translate(-5,-1)"/>
                    <polygon id="mountain" points="30,6 5,50 55,50"/>
                </defs>
            </svg>
            <table>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            </table>
            <h3 style="margin-top:30px">Recall:</h3>
            1st screen &rArr; initial <strong>::</strong> screen on 0 &rArr; goal <strong>::</strong> screen on &ne; 0 &rArr; current
            <hr>
            <strong>Avoid:</strong><br>
            - Initial shape is square or diamond &rArr; Triangular numbers<br>
            - 3 | initial value &rArr; Multiples of 7<br>
            - Initial shape has a + sign &rArr; Prime numbers<br>
            - Otherwise &rArr; Fibonacci numbers
            </div>
        <div class="page-footer relative-footer">Page 1 of 1</div>
    </div>
</div>
    <script>
        function alterSVG() {
            const inputArr = inputValues();
                for (let i = 0; i < 8; i++)
                    Array.from(document.getElementsByClassName(shapeNames[i])).forEach(cell => {
                        cell.childNodes[0].setAttribute('visibility', 'hidden');
                        cell.childNodes[1].innerHTML = cell.childNodes[1].innerHTML[0] + inputArr[i];
                    });
        }

        function alterSVG(data) {
            if (isFirstInput) {
                for (let i = 0; i < 8; i++)
                    Array.from(document.getElementsByClassName(shapeNames[i])).forEach(cell => {
                        cell.childNodes[0].setAttribute('visibility', 'hidden');
                        cell.childNodes[1].innerHTML = cell.childNodes[1].innerHTML[0] + '?';
                    });
                isFirstInput = false;
            }

            const shapesArr = Array.from(document.getElementsByClassName(shapeNames[data[0]]));
            shapesArr.forEach(cell => cell.childNodes[1].innerHTML = cell.childNodes[1].innerHTML[0] + (data[1] ? data[1] : '?'));
        }

        function resetShapes() {
            isFirstInput = true;
            for (let i = 0; i < 8; i++)
                Array.from(document.getElementsByClassName(shapeNames[i])).forEach(cell => {
                    cell.childNodes[0].setAttribute('visibility', 'visible');
                    cell.childNodes[1].innerHTML = cell.childNodes[1].innerHTML[0];
                });
        }

        function resetAll() {
            resetShapes();
            Array.from(inputs).forEach(input => input.value = "");
        }

        function initConstructSCP() {
            Array.from(document.getElementsByTagName('td')).forEach( (td, i) => {

                const div = document.createElement('div');
                const svg = document.createElementNS(ns, 'svg');
                const newShape = document.getElementById(shapeNames[shapes[i]]).cloneNode();
                const text = document.createElementNS(ns, 'text');

                svg.setAttribute('class', newShape.getAttribute('id'));
                svg.setAttribute("width","100%");
                svg.setAttribute("viewBox","0 0 60 55");
                div.setAttribute("width","60");
                div.setAttribute("height","55");
                newShape.removeAttribute('id');
                text.innerHTML = shapesSign[i];

                svg.appendChild(newShape);
                svg.appendChild(text);
                div.appendChild(svg);
                td.appendChild(div);
            });
            document.getElementsByTagName("svg")[8].remove();
            if (window.location.hash) checkHash();
        }

        const differentNumbers = (inputted) => !inputValues().filter(n => n >= '1' && n <= '9').some(number => number === inputted);
        const permittedKeys = (key) => [8, 9, 46, 49, 50, 51, 52, 53, 54, 55, 56, 57, 97, 98, 99, 100, 101, 102, 103, 104, 105].find(x => x === key);
        const inputValues = () => Array.from(inputs, i => i.value);
        const areInputsEmpty = () => inputValues().filter(x => x).length === 0;

        const shapeNames = ["circle", "diamond", "triangle", "heart", "hexagon", "square", "star", "mountain"];
        const inputs = document.getElementsByTagName("input");
        const shapes = [
        4, 6, 2, 5, 0, 1, 7, 3,
        7, 3, 1, 0, 2, 5, 4, 6,
        6, 7, 5, 2, 1, 0, 3, 4,
        3, 4, 0, 1, 6, 2, 5, 7,
        2, 5, 6, 3, 7, 4, 1, 0,
        1, 0, 4, 7, 3, 6, 2, 5,
        0, 1, 3, 4, 5, 7, 6, 2,
        5, 2, 7, 6, 4, 3, 0, 1 ];
        const shapesSign = [
        "+", "+", "-", "-", "+", "+", "-", "-",
        "-", "+", "-", "-", "+", "+", "-", "+",
        "+", "-", "+", "+", "-", "-", "+", "-",
        "+", "-", "-", "+", "-", "+", "+", "-",
        "-", "+", "+", "-", "+", "-", "-", "+",
        "-", "+", "-", "+", "-", "-", "+", "+",
        "+", "-", "+", "+", "-", "+", "-", "-",
        "-", "-", "+", "-", "+", "-", "+", "+" ];
        const ns = 'http://www.w3.org/2000/svg';
        let isFirstInput = true;

        Array.from(inputs).forEach((input, i) => {
            input.addEventListener('keydown', e => {
                if (!permittedKeys(e.which) || !differentNumbers(e.key))
                    e.preventDefault();
            });
            input.addEventListener("input", e => {
                input.value = e.data;
                if (areInputsEmpty()) resetShapes();
                else alterSVG([i, input.value]);
            });
        });

        function hashMoves(hash) {
            const start = hash.start;
            const tbodyChildrenArray = Array.from(document.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));

            const getShapeCell = (shape, sign, loc) => Array.from(document.getElementsByClassName(shape))
                            .filter(svg => svg.getElementsByTagName('text')[0].innerHTML[0] === sign)[loc].parentNode.parentNode

            const getRowChildrenFromCell = (cell) => cell.parentNode.getElementsByTagName('td'); //get cell => get its row => get its tds
            const getRowChildrenFromBody = (rowIndex) => tbodyChildrenArray[rowIndex].getElementsByTagName('td'); //get body => select row by index => get its tds

            const getCellIndex = (cell) => Array.from(getRowChildrenFromCell(cell)).indexOf(cell); //index of cell from its row
            const getRowIndex = (cell) => tbodyChildrenArray.indexOf(cell.parentNode); //index of row from tbody

            const getCellInRow = (rowIndex, cellIndex) => getRowChildrenFromBody(rowIndex)[cellIndex]; //get cell at (row, cell)
            const getCellInSameRow = (cell, cellIndex) => getRowChildrenFromCell(cell)[cellIndex] //get cell at its row by custom index

            const wrap = (index) => (index < 0 ? index += 8 : index) % 8; //ensures index € [0,7]

            const moveUp = (cell) => getCellInRow(wrap(getRowIndex(cell)-1), getCellIndex(cell));
            const moveRight = (cell) => getCellInSameRow(cell, wrap(getCellIndex(cell)+1));
            const moveDown = (cell) => getCellInRow(wrap(getRowIndex(cell)+1), getCellIndex(cell));
            const moveLeft = (cell) => getCellInSameRow(cell, wrap(getCellIndex(cell)-1));

            const moves = Array.from(hash.moves);
            const moveFuncs = (cell) => [moveUp(cell), moveRight(cell), moveDown(cell), moveLeft(cell)];

            let currentCell = getShapeCell(start.shape, start.sign, start.location);
            currentCell.style.backgroundColor = 'blue';

            moves.forEach(move => {
                currentCell = moveFuncs(currentCell)[move];
                currentCell.style.backgroundColor = 'cyan';
            });
            currentCell.style.backgroundColor = 'orange';
        }

        function checkHash() {
            const hash = JSON.parse(decodeURI(window.location.hash.substr(1)));
            if (hash.shapeData.enabled) {
                const numbers = Array.from(hash.shapeData.numbers.toString());
                Array.from(inputs).forEach((input, index) => input.value = numbers[index]);
                Array.from(inputs).forEach((input, i) => alterSVG([i, input.value]));
            }
            hashMoves(hash);
        }

        //example: #{"start":{"shape":"hexagon","sign":"-","location":2},"moves":"0000111111001111100100332","shapeData":{"enabled":true,"numbers":"29756348"}}

        window.addEventListener('DOMContentLoaded', () => initConstructSCP());
    </script>
</body>
</html>