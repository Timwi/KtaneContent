<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Pseudocrypt — Keep Talking and Nobody Explodes Module</title>
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/jquery.3.1.1.min.js"></script>
    <script>
        $(function() {
            const text = [
                "A HALFMOON GLOWED ON SMOOTH GRANITE BOULDERS TURNING THEM SILVER", "THE SILENCE WAS BROKEN ONLY BY THE RIPPLE OF WATER FROM THE SWIFT BLACK RIVER AND THE WHISPER OF TREES IN THE FOREST BEYOND", "THERE WAS A STIRRING IN THE SHADOWS AND FROM ALL AROUND LITHE DARK SHAPES CREPT STEALTHILY OVER THE ROCKS", "UNSHEATHED CLAWS GLINTED IN THE MOONLIGHT", "WARY EYES FLASHED LIKE AMBER",
                "AND THEN AS IF ON A SILENT SIGNAL THE CREATURES LEAPED AT EACH OTHER AND SUDDENLY THE ROCKS WERE ALIVE WITH WRESTLING SCREECHING CATS", "AT THE CENTER OF THE FRENZY OF FUR AND CLAWS A MASSIVE DARK TABBY PINNED A BRACKENCOLORED TOM TO THE GROUND AND DREW UP HIS HEAD TRIUMPHANTLY", "OAKHEART THE TABBY GROWLED", "HOW DARE YOU HUNT IN OUR TERRITORY THE SUNNINGROCKS BELONG TO THUNDERCLAN",
                "AFTER TONIGHT TIGERCLAW THIS WILL BE JUST ANOTHER RIVERCLAN HUNTING GROUND THE BRACKENCOLORED TOM SPAT BACK", "A WARNING YOWL CAME FROM THE SHORE SHRILL AND ANXIOUS", "LOOK OUT MORE RIVERCLAN WARRIORS ARE COMING", "TIGERCLAW TURNED TO SEE SLEEK WET BODIES SLIDING OUT OF THE WATER BELOW THE ROCKS",
                "THE DRENCHED RIVERCLAN WARRIORS BOUNDED SILENTLY UP THE SHORE AND HURLED THEMSELVES INTO BATTLE WITHOUT EVEN STOPPING TO SHAKE THE WATER FROM THEIR FUR", "THE DARK TABBY GLARED DOWN AT OAKHEART", "YOU MAY SWIM LIKE OTTERS BUT YOU AND YOUR WARRIORS DO NOT BELONG IN THIS FOREST", "HE DREW BACK HIS LIPS AND SHOWED HIS TEETH AS THE CAT STRUGGLED BENEATH HIM",
                "THE DESPERATE SCREAM OF A THUNDERCLAN SHECAT ROSE ABOVE THE CLAMOR", "A WIRY RIVERCLAN TOM HAD PINNED THE BROWN WARRIOR FLAT ON HER BELLY", "NOW HE LUNGED TOWARD HER NECK WITH JAWS STILL DRIPPING FROM HIS SWIM ACROSS THE RIVER", "TIGERCLAW HEARD THE CRY AND LET GO OF OAKHEART", "WITH A MIGHTY LEAP HE KNOCKED THE ENEMY WARRIOR AWAY FROM THE SHECAT",
                "QUICK MOUSEFUR RUN HE ORDERED BEFORE TURNING ON THE RIVERCLAN TOM WHO HAD THREATENED HER", "MOUSEFUR SCRAMBLED TO HER PAWS WINCING FROM A DEEP GASH ON HER SHOULDER AND RACED AWAY", "BEHIND HER TIGERCLAW SPAT WITH RAGE AS THE RIVERCLAN TOM SLICED OPEN HIS NOSE", "BLOOD BLINDED HIM FOR AN INSTANT BUT HE LUNGED FORWARD REGARDLESS AND SANK HIS TEETH INTO THE HIND LEG OF HIS ENEMY",
                "THE RIVERCLAN CAT SQUEALED AND STRUGGLED FREE", "TIGERCLAW", "THE YOWL CAME FROM A WARRIOR WITH A TAIL AS RED AS FOX FUR", "THIS IS USELESS THERE ARE TOO MANY RIVERCLAN WARRIORS", "NO REDTAIL", "THUNDERCLAN WILL NEVER BE BEATEN TIGERCLAW YOWLED BACK LEAPING TO REDTAILS SIDE", "THIS IS OUR TERRITORY", "BLOOD WAS WELLING AROUND HIS BROAD BLACK MUZZLE AND HE SHOOK HIS HEAD IMPATIENTLY SCATTERING SCARLET DROPS ONTO THE ROCKS",
                "THUNDERCLAN WILL HONOR YOUR COURAGE TIGERCLAW BUT WE CANNOT AFFORD TO LOSE ANY MORE OF OUR WARRIORS REDTAIL URGED", "BLUESTAR WOULD NEVER EXPECT HER WARRIORS TO FIGHT AGAINST THESE IMPOSSIBLE ODDS", "WE WILL HAVE ANOTHER CHANCE TO AVENGE THIS DEFEAT", "HE MET TIGERCLAWS AMBEREYED GAZE STEADILY THEN REARED AWAY AND SPRANG ONTO A BOULDER AT THE EDGE OF THE TREES", "RETREAT THUNDERCLAN",
                "RETREAT HE YOWLED", "AT ONCE HIS WARRIORS SQUIRMED AND STRUGGLED AWAY FROM THEIR OPPONENTS", "SPITTING AND SNARLING THEY BACKED TOWARD REDTAIL", "FOR A HEARTBEAT THE RIVERCLAN CATS LOOKED CONFUSED", "WAS THIS BATTLE SO EASILY WON THEN OAKHEART YOWLED A JUBILANT CRY", "AS SOON AS THEY HEARD HIM THE RIVERCLAN WARRIORS RAISED THEIR VOICES AND JOINED THEIR DEPUTY IN CATERWAULING THEIR VICTORY",
                "REDTAIL LOOKED DOWN AT HIS WARRIORS", "WITH A FLICK OF HIS TAIL HE GAVE THE SIGNAL AND THE THUNDERCLAN CATS DIVED DOWN THE FAR SIDE OF THE SUNNINGROCKS THEN DISAPPEARED INTO THE TREES", "TIGERCLAW FOLLOWED LAST", "HE HESITATED AT THE EDGE OF THE FOREST AND GLANCED BACK AT THE BLOODSTAINED BATTLEFIELD", "HIS FACE WAS GRIM HIS EYES FURIOUS SLITS", "THEN HE LEAPED AFTER HIS CLAN INTO THE SILENT FOREST",
                "IN A DESERTED CLEARING AN OLD GRAY SHECAT SAT ALONE STARING UP AT THE CLEAR NIGHT SKY", "ALL AROUND HER IN THE SHADOWS SHE COULD HEAR THE BREATHING AND STIRRINGS OF SLEEPING CATS", "A SMALL TORTOISESHELL SHECAT EMERGED FROM A DARK CORNER HER PAWSTEPS QUICK AND SOUNDLESS", "THE GRAY CAT DIPPED HER HEAD IN GREETING", "HOW IS MOUSEFUR SHE MEOWED",
                "HER WOUNDS ARE DEEP BLUESTAR ANSWERED THE TORTOISESHELL SETTLING HERSELF ON THE NIGHTCOOL GRASS", "BUT SHE IS YOUNG AND STRONG SHE WILL HEAL QUICKLY", "AND THE OTHERS", "THEY WILL ALL RECOVER TOO", "BLUESTAR SIGHED", "WE ARE LUCKY NOT TO HAVE LOST ANY OF OUR WARRIORS THIS TIME", "YOU ARE A GIFTED MEDICINE CAT SPOTTEDLEAF", "SHE TILTED HER HEAD AGAIN AND STUDIED THE STARS",
                "I AM DEEPLY TROUBLED BY TONIGHTS DEFEAT", "THUNDERCLAN HAS NOT BEEN BEATEN IN ITS OWN TERRITORY SINCE I BECAME LEADER SHE MURMURED", "THESE ARE DIFFICULT TIMES FOR OUR CLAN", "THE SEASON OF NEWLEAF IS LATE AND THERE HAVE BEEN FEWER KITS", "THUNDERCLAN NEEDS MORE WARRIORS IF IT IS TO SURVIVE", "BUT THE YEAR IS ONLY JUST BEGINNING SPOTTEDLEAF POINTED OUT CALMLY",
                "THERE WILL BE MORE KITS WHEN GREENLEAF COMES", "THE GRAY CAT TWITCHED HER BROAD SHOULDERS", "PERHAPS", "BUT TRAINING OUR YOUNG TO BECOME WARRIORS TAKES TIME", "IF THUNDERCLAN IS TO DEFEND ITS TERRITORY IT MUST HAVE NEW WARRIORS AS SOON AS POSSIBLE", "ARE YOU ASKING STARCLAN FOR ANSWERS MEOWED SPOTTEDLEAF GENTLY FOLLOWING BLUESTARS GAZE AND STARING UP AT THE SWATH OF STARS GLITTERING IN THE DARK SKY",
                "IT IS AT TIMES LIKE THIS WE NEED THE WORDS OF ANCIENT WARRIORS TO HELP US", "HAS STARCLAN SPOKEN TO YOU BLUESTAR ASKED", "NOT FOR SOME MOONS BLUESTAR", "SUDDENLY A SHOOTING STAR BLAZED OVER THE TREETOPS", "SPOTTEDLEAFS TAIL TWITCHED AND THE FUR ALONG HER SPINE BRISTLED", "BLUESTARS EARS PRICKED BUT SHE REMAINED SILENT AS SPOTTEDLEAF CONTINUED TO GAZE UPWARD",
                "AFTER A FEW MOMENTS SPOTTEDLEAF LOWERED HER HEAD AND TURNED TO BLUESTAR", "IT WAS A MESSAGE FROM STARCLAN SHE MURMURED", "A DISTANT LOOK CAME INTO HER EYES", "FIRE ALONE CAN SAVE OUR CLAN", "FIRE BLUESTAR ECHOED", "BUT FIRE IS FEARED BY ALL THE CLANS HOW CAN IT SAVE US", "SPOTTEDLEAF SHOOK HER HEAD", "I DO NOT KNOW SHE ADMITTED", "BUT THIS IS THE MESSAGE STARCLAN HAS CHOSEN TO SHARE WITH ME",
                "THE THUNDERCLAN LEADER FIXED HER CLEAR BLUE EYES ON THE MEDICINE CAT", "YOU HAVE NEVER BEEN WRONG BEFORE SPOTTEDLEAF SHE MEOWED", "IF STARCLAN HAS SPOKEN THEN IT MUST BE SO", "FIRE WILL SAVE OUR CLAN"
            ];

            const pageExtra = { 2:-2, 5:3, 6:2 };
            const ROWS_PER_PAGE = 17;
            const ROWS = text.length;
            let body = $("div.section");
            let excerpt = text[0];
            let exWords = excerpt.split(" ");
            let pageNum = 2;
            const lengthSet = new Set();
            const nonUnique = new Set();
            const uniqueEx = new Set();
            const problemLength = {
                "3 4 3 4": 5,
                "1 7 4 4": 7,
                "3 6 3 4": 5
            }

            for (let p = 0; p < ROWS;) {
                let page = $("<div>").addClass(`page page-bg-0${pageNum % 7 + 1}`).appendTo(body);
                $('<div class="page-header"><span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span><span class="page-header-section-title">Pseudocrypt</span></div>')
                    .appendTo(page);
                let content = $("<div>").addClass("page-content lookup-tables").appendTo(page);
                let table = $("<table>").addClass("lookup").appendTo(content);
                let tr = $("<tr>").appendTo(table);
                $("<th>").text("Word Lengths").appendTo(tr);
                $("<th>").text("Phrase").appendTo(tr);
                let i = p;
                let extra = pageNum in pageExtra ? pageExtra[pageNum] : 0;
                for (; exWords.length > 0 && i < (p + extra + ROWS_PER_PAGE) && i < ROWS; i++) {
                    if (!uniqueEx.has(excerpt)) {
                        let tr2 = $("<tr>").appendTo(table);
                        let lengths = [];
                        let td2 = $("<td>");
                        for (let w = 0; w < exWords.length; w++) {
                            lengths.push(exWords[w].length);
                            $("<span>").addClass("highlightable").text(exWords[w]).appendTo(td2);
                            td2.append(" ");
                        }
                        let end = Math.min(4, lengths.length);
                        let lengthsStr = lengths.slice(0, end).join(" ");
                        if (lengthsStr in problemLength) {
                            lengthsStr = lengths.slice(0, problemLength[lengthsStr]).join(" ");
                            nonUnique.add(lengthsStr);
                        }
                        // if (lengthSet.has(lengthsStr))
                        //     nonUnique.add(lengthsStr);
                        lengthSet.add(lengthsStr);
                        uniqueEx.add(excerpt);
                        $("<td>").text(lengthsStr).appendTo(tr2);
                        td2.appendTo(tr2);
                    }
                    else
                        extra++;
                    if (i < ROWS - 1) {
                        excerpt = text[i+1];
                        exWords = excerpt.split(" ");
                    }
                }
                p = i;
                $("<div>").addClass("page-footer relative-footer").text(pageNum).appendTo(page);
                pageNum++;
            }
            $("table.lookup td:nth-child(1)").each(function(i) {
                if (nonUnique.has($(this).text()))
                    $(this).addClass("notunique");
            });

            // console.log(document.getElementsByClassName('lookup')[0].innerHTML);
            $("td span").addClass("highlightable");
            $("table.lookup td:nth-child(2)").addClass("nohighlight");
        });
    </script>
    <script src="js/ktane-utils.js"></script>
    <style>
        table.lookup td:nth-child(1) {
            background-color: #FFF;;
            /* font-size: 9pt; */
            width: 29%;
        }
        .page-footer::before { content: 'Page '; }
        .page-footer::after { content: ' of 7'; }
        .dark table.lookup td:nth-child(1) { background-color: #222; }

        table.lookup td:nth-child(1).notunique { background-color: #BBB; }
        .dark table.lookup td:nth-child(1).notunique { background-color: #777; }
    </style>
</head>
<body>
    <div class="section">
        <div class="page page-bg-05">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Pseudocrypt</span>
            </div>
            <div class="page-content">
                <img src="img/Component/Pseudocrypt.svg" class="diagram">
                <h2>On the Subject of Pseudocrypt</h2>
                <p class="flavour-text">Schwabbledabbleglibbeglabbe schwibbleschwabglab; Dibbledabble schwibbleschwabble glibbleglabschwab.
                    Schwabbledabbleglibbeglabbe schwibbleschwabdab; Dibbledabble schwibbleschwabble glibbleschwabglab!</p>
                <p>The display shows a sentence from the prologue of “Into the Wild”, the first book in the “Warriors” series by Erin Hunter.</p>
                <p>However, all punctuation has been removed, and every instance of a letter has been replaced with another letter, except for one.</p>
                <p>Identify the sentence that has been encrypted by using the words in the lookup table,
                    and determine which letter has not been replaced with another.</p>
                <p>Note that 4 word lengths are enough to uniquely identify the phrase, <em>with a few exceptions (shown in gray).</em></p>
                <p><em>Note also that some phrases are less than 4 words.</em></p>
                <p>Use the left and right arrows to change the current letter on the submit button.</p>
                <p>Press the submit button to submit that letter. Submitting the incorrect letter will incur a strike, but not reset the module.
                    Submitting the correct letter will disarm the module.</p>
            </div>
            <div class="page-footer relative-footer">1</div>
        </div>
    </div>
</body>
</html>