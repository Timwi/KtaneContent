<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Wordpath — Keep Talking and Nobody Explodes Module</title>
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/ktane-utils.js"></script>
    <script src="js/jquery.3.7.0.min.js"></script>
    <script>
    $(function() {
        let popup = $(".popup");
        let page = $(".page-bg-02 .page-content");
        $("th img").click(function(event) {
            popup.html(this.cloneNode());
            popup.removeClass("invis");
            popup.css({
                left:(page[0].clientWidth / 2 - popup[0].clientWidth / 2),
                top:(event.pageY - page.offset().top - popup[0].clientHeight - this.clientHeight)
            });
            event.preventDefault();
            event.stopPropagation();
        });
        $(document).click(function() {
            popup.addClass("invis");
        });
    });
    </script>
    <style>
        .dark table, table {
            margin: 1em auto;
            width: 100%;
            font-size: 13.8px;
            border: none;
        }
        th img {
            width: 100%;
            cursor: pointer;
        }
        .head2 {
            font-weight: bold;
            font-size: 1.5em;
            text-decoration: underline;
        }
        .invis { opacity: 0; }
        .page-content { position: relative; }
        .popup img {
            width: 200px;
        }
        .popup {
            position: absolute;
            transition: opacity 0.3s;
            border: 1px solid black;
            padding: 0.5em;
            background: #fafaff;
            box-shadow: 5px 5px 5px #88888844;
            z-index: 100;
            user-select: none;
            pointer-events: none;
        }
        .dark .popup { background: #222; }
        .dark th img, .dark .popup img { filter: invert(85%); }
        #controls {
        width: 100%;
        }

        button {
        width: 19%;
        margin-bottom: 8px;
        padding: 8px;
        }

        #frame {
        position: relative;
        width: 600px;
        height: 600px;
        }

        svg {
        width: 600px;
        height: 600px;
        background: transparent;
        border: transparent;
        }

        .hex {
        stroke: #444;
        stroke-width: 1.2;
        fill: #fafafa;
        cursor: pointer;
        }
        .hex.outer { fill: #b0b0b0; }
        .hex.blue  { fill: #4da6ff; }
        .hex.red   { fill: #ff6b6b; }
        .hex.purple { fill: #7030e6; }
        .hex.cursor { fill: #ffe066; }

        .letter {
        font-size: 20px;
        font-weight: bold;
        text-anchor: middle;
        dominant-baseline: middle;
        pointer-events: none;
        }

        .number {
        font-size: 11px;
        font-weight: bold;
        fill: #222;
        pointer-events: none;
        }

        .arrow {
        position: absolute;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 1px solid #444;
        background: white;
        font-size: 22px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        }
        button.active {
            background-color: #87cefa;
            color: #000;
            font-weight: bold;
        }
        button.confirm {
            background-color: rgb(255, 94, 94);
            color: #000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="section">
        <div class="page page-bg-06">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Wordpath</span>
            </div>
            <div class="page-content">
                <img src="img/Component/Wordpath.svg" class="diagram">
                <h2>On the Subject of Wordpaths</h2>
                <p class="flavour-text">Not all who wander are lost.</p>
                <p>On the module is a hexagonal grid of cells, each labelled with a single letter.<br>Note the letters in the cells and their arrangement before pressing the hexagonal button.</p>
                <p>When the button is pressed, the grid will recede into the module and a flashing arrow will appear in its place.<br>This arrow flashes a sequence of moves from an unknown starting cell forming a path:</p>
                <ul><li>Each move goes to the adjacent cell in the direction the arrow is pointing.</li><li>At no point does the path leave the grid.</li></ul>
                <p>
                    The arrow will turn blue exactly five times before the sequence repeats.<br>
                    The letter in the starting cell followed by the letters of the cells landed on after each blue-arrowed move, in order, spell out one of the six letter words in Table X.<br>
                    Once the path is traced and the word found, assign a cardinal direction from Table P according to conditions satisfied by the path.<br>
                    In Table X, move one space from the obtained word in the assigned direction, wrapping around the edges of the table if necessary, to obtain a polyhex.
                </p>
                <p>
                    Pressing the hexagonal button again will stop the sequence and a letterless grid will emerge with the center cell highlighted in white.<br>
                    In this state, pressing one of the outer buttons will move the highlight to the adjacent cell in the direction it is pointing.
                </p>
                <p>Pressing the hexagonal button once more will cause cells that are visited from this point on to be highlighted in blue.</p>
                <ol>
                    <li>The boundary of the cells in the highlighted region must match the obtained polyhex.</li>
                    <li>The highlighted region must contain exactly one of cells from which the word was obtained.</li>
                    <li>This cell must be highlighted in white.</li>
                </ol>
                <p>
                    Press the hexagonal button one final time to submit the highlighted region.<br>
                    If the submission meets all of the above criteria, the module is solved.<br>
                    Otherwise, the module will reset to its initial state, removing all highlights from the grid and revealing the letters once again.
                </p>
            </div>
            <div class="page-footer relative-footer">Page 1 of 2</div>
        </div>
        <div class="page page-bg-02">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Wordpath</span>
            </div>
            <div class="page-content">
                <h2>Table P</h2>
                <p>To assign a direction, use the first conditions that apply from top to bottom and left to right, to obtain the respective row and column of the cell containing the assigned direction.</p>
                <table>
                    <tr><th class="corner"></th>
                        <th>If path cells never contain a letter in the serial number.</th>
                        <th>Otherwise, if any red cell is adjacent to the 'Z' cell.</th>
                        <th>Otherwise, if red cell #1 lies on the edge of the white grid.</th>
                        <th>Otherwise</th>
                    </tr>
                    <tr><th>If you have indicators and path cells contain all letters from all indicators.</th><th>UP</th><th>RIGHT</th><th>DOWN</th><th>LEFT</th></tr>
                    <tr><th>Otherwise, if 'Z' is in the path.</th><th>RIGHT</th><th>UP</th><th>LEFT</th><th>DOWN</th></tr>
                    <tr><th>Otherwise, if any non-red letter appears four or more times in blue cells*.</th><th>DOWN</th><th>LEFT</th><th>UP</th><th>RIGHT</th></tr>
                    <tr><th>Otherwise</th><th>LEFT</th><th>DOWN</th><th>RIGHT</th><th>UP</th></tr>
                </table>
                <p style="font-size: 12px;">* <i>Cells landed on multiple times count that many times, not just once.</i></p>
                <div class="popup invis"></div>
                <p><span class="head2">Table X</span> &nbsp; (click a polyhex to enlarge)</p>
                <table style="font-size:8.3px">
                    <tr>
                        <th><img src="img/Wordpath/PolyA1.svg"></th><th>CAVITY</th><th><img src="img/Wordpath/PolyA2.svg"></th><th>IMPROV</th>
                        <th><img src="img/Wordpath/PolyA3.svg"></th><th>REDACT</th><th><img src="img/Wordpath/PolyA4.svg"></th><th>STUDIO</th>
                        <th><img src="img/Wordpath/PolyA5.svg"></th><th>MAGNET</th><th><img src="img/Wordpath/PolyA6.svg"></th><th>THUSLY</th>
                        <th><img src="img/Wordpath/PolyA7.svg"></th><th>WEBLOG</th><th><img src="img/Wordpath/PolyA8.svg"></th><th>LARYNX</th>
                    </tr>
                    <tr>
                        <th>ECLAIR</th><th><img src="img/Wordpath/PolyB1.svg"></th><th>WHACKS</th><th><img src="img/Wordpath/PolyB2.svg"></th>
                        <th>PROVEN</th><th><img src="img/Wordpath/PolyB3.svg"></th><th>ATOMIC</th><th><img src="img/Wordpath/PolyB4.svg"></th>
                        <th>FRUGAL</th><th><img src="img/Wordpath/PolyB5.svg"></th><th>JASPER</th><th><img src="img/Wordpath/PolyB6.svg"></th>
                        <th>UTOPIA</th><th><img src="img/Wordpath/PolyB7.svg"></th><th>HUNGRY</th><th><img src="img/Wordpath/PolyB8.svg"></th>
                    </tr>
                    <tr>
                        <th><img src="img/Wordpath/PolyC1.svg"></th><th>ADJOIN</th><th><img src="img/Wordpath/PolyC2.svg"></th><th>VORTEX</th>
                        <th><img src="img/Wordpath/PolyC3.svg"></th><th>QINTAR</th><th><img src="img/Wordpath/PolyC4.svg"></th><th>CRYPTS</th>
                        <th><img src="img/Wordpath/PolyC5.svg"></th><th>XENIAS</th><th><img src="img/Wordpath/PolyC6.svg"></th><th>OTHERS</th>
                        <th><img src="img/Wordpath/PolyC7.svg"></th><th>WYVERN</th><th><img src="img/Wordpath/PolyC8.svg"></th><th>OUTING</th>
                    </tr>
                    <tr>
                        <th>NICKEL</th><th><img src="img/Wordpath/PolyD1.svg"></th><th>GLITCH</th><th><img src="img/Wordpath/PolyD2.svg"></th>
                        <th>KEYPAD</th><th><img src="img/Wordpath/PolyD3.svg"></th><th>INFLUX</th><th><img src="img/Wordpath/PolyD4.svg"></th>
                        <th>OBJECT</th><th><img src="img/Wordpath/PolyD5.svg"></th><th>EMBARK</th><th><img src="img/Wordpath/PolyD6.svg"></th>
                        <th>TORQUE</th><th><img src="img/Wordpath/PolyD7.svg"></th><th>SILVER</th><th><img src="img/Wordpath/PolyD8.svg"></th>
                    </tr>
                    <tr>
                        <th><img src="img/Wordpath/PolyE1.svg"></th><th>QUOTAS</th><th><img src="img/Wordpath/PolyE2.svg"></th><th>PHYLUM</th>
                        <th><img src="img/Wordpath/PolyE3.svg"></th><th>NUMBER</th><th><img src="img/Wordpath/PolyE4.svg"></th><th>MOSAIC</th>
                        <th><img src="img/Wordpath/PolyE5.svg"></th><th>KNIVES</th><th><img src="img/Wordpath/PolyE6.svg"></th><th>SPHINX</th>
                        <th><img src="img/Wordpath/PolyE7.svg"></th><th>DETAIL</th><th><img src="img/Wordpath/PolyE8.svg"></th><th>BROWSE</th>
                    </tr>
                    <tr>
                        <th>FORGET</th><th><img src="img/Wordpath/PolyF1.svg"></th><th>SQUAWK</th><th><img src="img/Wordpath/PolyF2.svg"></th>
                        <th>YACHTS</th><th><img src="img/Wordpath/PolyF3.svg"></th><th>DOUBLE</th><th><img src="img/Wordpath/PolyF4.svg"></th>
                        <th>JUMPER</th><th><img src="img/Wordpath/PolyF5.svg"></th><th>WIDGET</th><th><img src="img/Wordpath/PolyF6.svg"></th>
                        <th>CITRUS</th><th><img src="img/Wordpath/PolyF7.svg"></th><th>ANTHEM</th><th><img src="img/Wordpath/PolyF8.svg"></th>
                    </tr>
                    <tr>
                        <th><img src="img/Wordpath/PolyG1.svg"></th><th>URCHIN</th><th><img src="img/Wordpath/PolyG2.svg"></th><th>RUSTIC</th>
                        <th><img src="img/Wordpath/PolyG3.svg"></th><th>BOXING</th><th><img src="img/Wordpath/PolyG4.svg"></th><th>HERMIT</th>
                        <th><img src="img/Wordpath/PolyG5.svg"></th><th>TRUDGE</th><th><img src="img/Wordpath/PolyG6.svg"></th><th>XYLOID</th>
                        <th><img src="img/Wordpath/PolyG7.svg"></th><th>LIMPET</th><th><img src="img/Wordpath/PolyG8.svg"></th><th>YONDER</th>
                    </tr>
                    <tr>
                        <th>LAUNCH</th><th><img src="img/Wordpath/PolyH1.svg"></th><th>ITSELF</th><th><img src="img/Wordpath/PolyH2.svg"></th>
                        <th>JUNGLE</th><th><img src="img/Wordpath/PolyH3.svg"></th><th>VERIFY</th><th><img src="img/Wordpath/PolyH4.svg"></th>
                        <th>CHROME</th><th><img src="img/Wordpath/PolyH5.svg"></th><th>UPSIDE</th><th><img src="img/Wordpath/PolyH6.svg"></th>
                        <th>GNARLY</th><th><img src="img/Wordpath/PolyH7.svg"></th><th>KLAXON</th><th><img src="img/Wordpath/PolyH8.svg"></th>
                    </tr>
                </table>
            </div>
            <div class="page-footer relative-footer">Page 2 of 2</div>
        </div>
        <div class="page page-bg-06">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Wordpath</span>
            </div>
            <div class="page-content">
                <div id="controls">
                <h3>Modes</h3>
                    <button id="letterBtn" onclick="setMode('letters')">Letter Mode</button>
                    <button id='pathBtn' onclick="setMode('path')">Path Mode</button>
                    <button id='imprintBtn' onclick="setMode('imprint')">Polyhex Mode</button>
                    <button id='rstPath' onclick="resetSave()">Reset Path</button>
                    <button id='rstAll' onclick="resetAll()">Reset All</button>
                </div>
                <ul>
                    <li>In Letter Mode, input letters.</li>
                    <li>In Path Mode, a grey buffer zone appears. Start your path in the center of the grid, then follow the arrow on the module, clicking on tiles to mark your path and right-clicking to mark tiles of your word. Once the path is complete, use the arrows to move the path back into the grid.</li>
                    <li>In Polyhex Mode, all red tiles from your path stays. Draw your polyhex and move it around; tiles will be marked purple if your polyhex overlaps red tiles.</li>
                    <li>Your path is saved when you move between modes, but is not removable. Use Reset Path to clear your path.</li>
                </ul>
                <div id="frame" style="user-select: none;">
                    <svg id="svg"></svg>
                </div>
                <script>
                document.addEventListener("contextmenu", e => e.preventDefault());

                //config
                const SIZE = 22;
                const ORIGIN = { x: 300, y: 300 };
                const WHITE_RADIUS = 3;
                const GREY_RADIUS  = 6;

                const DIRS = [
                { dq:  1, dr:  0 },
                { dq:  1, dr: -1 },
                { dq:  0, dr: -1 },
                { dq: -1, dr:  0 },
                { dq: -1, dr:  1 },
                { dq:  0, dr:  1 }
                ];

                // state
                let mode = "path";
                const cells = {};
                var saveState = [];
                const orderedCells = [];
                let cursorIndex = 0;

                let path = [];
                let redCounter = 1;

                //hex math
                function hexToPixel(q, r) {
                    return {
                        x: ORIGIN.x + SIZE * (1.5 * q),
                        y: ORIGIN.y + SIZE * (Math.sqrt(3) * r + Math.sqrt(3)/2 * q)
                    };
                }

                function hexPoints(cx, cy) {
                    return Array.from({ length: 6 }, (_, i) => {
                        const a = Math.PI / 3 * i;
                        return `${cx + SIZE * Math.cos(a)},${cy + SIZE * Math.sin(a)}`;
                    }).join(" ");
                }

                function inRadius(q, r, rad) {
                    return Math.abs(q) <= rad &&
                            Math.abs(r) <= rad &&
                            Math.abs(q + r) <= rad;
                }

                //grid
                const svg = document.getElementById("svg");

                function makeHex(q, r, outer) {
                    const { x, y } = hexToPixel(q, r);

                    const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    poly.setAttribute("points", hexPoints(x, y));
                    poly.classList.add("hex");
                    if (outer) poly.classList.add("outer");

                    const letter = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    letter.setAttribute("x", x);
                    letter.setAttribute("y", y);
                    letter.classList.add("letter");

                    const number = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    number.setAttribute("x", x - SIZE * 0.45);
                    number.setAttribute("y", y - SIZE * 0.35);
                    number.classList.add("number");

                    svg.append(poly, letter, number);

                    const cell = {
                        q, r, outer,
                        poly, letter, number,
                        imprinted: false,
                    };

                    cells[`${q},${r}`] = cell;
                    if (!outer) orderedCells.push(cell);

                    poly.addEventListener("pointerdown", e => {
                        const segIndex = path.findIndex(p => p.q === q && p.r === r);
                        const seg = segIndex !== -1 ? path[segIndex] : null;

                        if (mode === "path") {
                            if (e.button === 2) { // right-click = red
                                if (!seg) {
                                    path.push({ q, r, red: true, number: redCounter++ });
                                } else if (!seg.red) {
                                    // overwrite blue with red
                                    seg.red = true;
                                    seg.number = redCounter++;
                                }
                            } else { // left-click = blue
                                if (!seg) {
                                    path.push({ q, r, red: false, number: 1 });
                                } else if (!seg.red) {
                                    seg.number++;
                                }
                            }
                            saveState = path;
                        }

                        render();

                        if (mode === "imprint") {
                        if (seg) {
                            // Remove blue only
                            if (!seg.red) path.splice(segIndex, 1);
                        } else {
                            path.push({ q, r, red: false, number: null });
                        }
                        }

                        if (mode === "letters" && !outer) {
                        cursorIndex = orderedCells.indexOf(cell);
                        }

                        render();
                    });
                }

                //render
                function render() {
                    Object.values(cells).forEach(c => {
                        c.poly.classList.remove("blue", "red", "purple", "cursor");
                        c.number.textContent = "";

                        c.poly.classList.add("hex");
                        if (c.outer) c.poly.classList.add("outer");

                        const seg = path.find(p => p.q === c.q && p.r === c.r);

                        if (c.imprinted && seg) {
                            c.poly.classList.add("purple");
                        } else if (c.imprinted) {
                            c.poly.classList.add("red");
                        } else if (seg) {
                            c.poly.classList.add(seg.red ? "red" : "blue");
                            c.number.textContent = seg.number;
                        }

                        if (mode === "letters" && orderedCells[cursorIndex] === c) {
                            c.poly.classList.add("cursor");
                        }
                    });
                }

               //movement
                function canLeaveWhite() {
                    return path.some(p => !inRadius(p.q, p.r, WHITE_RADIUS));
                }

                function movePath(dir) {
                    const { dq, dr } = DIRS[dir];

                    for (const p of path) {
                        const nq = p.q + dq;
                        const nr = p.r + dr;
                        if (!cells[`${nq},${nr}`]) return;
                        if (!canLeaveWhite() && !inRadius(nq, nr, WHITE_RADIUS)) return;
                    }

                    for (const p of path) {
                        p.q += dq;
                        p.r += dr;
                    }

                    render();
                }

                //input
                document.addEventListener("keydown", e => {
                    if (mode !== "letters") return;
                    const c = orderedCells[cursorIndex];
                    if (!c) return;

                    if (/^[a-zA-Z]$/.test(e.key)) {
                        c.letter.textContent = e.key.toUpperCase();
                        cursorIndex = Math.min(cursorIndex + 1, orderedCells.length - 1);
                    }

                    if (e.key === "Backspace") {
                        c.letter.textContent = "";
                        if (cursorIndex > 0) cursorIndex--;
                    }

                    render();
                });

                //modes
                function setMode(m) {
                    if (mode === "path" && m === "imprint") {
                        path.forEach(p => {
                        if (p.red) {
                            const c = cells[`${p.q},${p.r}`];
                            c.imprinted = true;
                        }
                        });
                        path = [];
                    }
                    
                    if (m === "path") {
                        removeConfirm();
                        mode = "path";
                        pathBtn.classList.add('active');
                        letterBtn.classList.remove('active');
                        imprintBtn.classList.remove('active');
                        Object.values(cells).forEach(c => {
                            c.imprinted = false;
                        });
                        path = saveState;
                    }

                    if (m === "letters") {
                        removeConfirm();
                        pathBtn.classList.remove('active');
                        letterBtn.classList.add('active');
                        imprintBtn.classList.remove('active');
                        Object.values(cells).forEach(c => {
                            c.imprinted = false;
                        });
                        path = [];

                    }

                    if (m === 'imprint') {
                        removeConfirm();
                        pathBtn.classList.remove('active');
                        letterBtn.classList.remove('active');
                        imprintBtn.classList.add('active');
                    }
                    mode = m;

                    Object.values(cells).forEach(c => {
                        c.poly.style.display =
                        (mode === "letters" && c.outer) ? "none" : "block";
                    });

                    arrows.forEach(a => {
                        a.style.display = (mode !== "letters") ? "flex" : "none";
                    });

                    render();
                }

                //reset
                function resetAll() {
                    if (!($(rstAll).hasClass('confirm'))) {
                        removeConfirm();
                        rstAll.classList.add('confirm');
                        rstAll.textContent = "Confirm?"
                    } else {
                        removeConfirm();
                        path = [];
                        redCounter = 1;
                        Object.values(cells).forEach(c => {
                            c.letter.textContent = "";
                            c.imprinted = false;
                        });
                        saveState = [];
                        setMode("letters");
                        render();
                    }
                }

                function resetSave() {
                    if (!($(rstPath).hasClass('confirm'))) {
                        removeConfirm();
                        rstPath.classList.add('confirm');
                        rstPath.textContent = "Confirm?"
                    } else {
                        removeConfirm(); 
                        path = [];
                        saveState = [];
                        redCounter = 1;
                        Object.values(cells).forEach(c => {
                            c.imprinted = false;
                        });
                        setMode("path");
                        render();
                    }
                }
                function removeConfirm() {
                    rstAll.classList.remove("confirm");
                    rstAll.textContent = "Reset All";
                    rstPath.classList.remove("confirm");
                    rstPath.textContent = "Reset Path";
                }
                //arrows
                const arrows = [];
                DIRS.forEach((d, i) => {
                    const btn = document.createElement("button");
                    btn.className = "arrow";
                    btn.textContent = "➤";

                    const p = hexToPixel(d.dq * 7.2, d.dr * 7.2);
                    btn.style.left = p.x - 21 + "px";
                    btn.style.top  = p.y - 21 + "px";
                    btn.style.transform = `rotate(${i * -60 + 30}deg)`;

                    btn.onclick = () => movePath(i);
                    frame.appendChild(btn);
                    arrows.push(btn);
                });

                //build
                for (let q = -GREY_RADIUS; q <= GREY_RADIUS; q++) {
                    for (let r = -GREY_RADIUS; r <= GREY_RADIUS; r++) {
                        if (Math.abs(q + r) <= GREY_RADIUS) {
                            makeHex(q, r, !inRadius(q, r, WHITE_RADIUS));
                        }
                    }
                }

                orderedCells.sort((a, b) =>
                    a.q - b.q ||
                    hexToPixel(a.q, a.r).y - hexToPixel(b.q, b.r).y
                );

                setMode("letters");
                render();
                </script>
            </div>
            <div class="page-footer relative-footer">Page 3 of 3</div>
        </div>
    </div>
</body>
</html>