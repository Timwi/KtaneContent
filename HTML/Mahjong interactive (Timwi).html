<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Mahjong — Keep Talking and Nobody Explodes Module</title>
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/ktane-utils.js"></script>
    <script src='js/ruleseed.js'></script>
    <style>
        .tile {
            display: inline-block;
            position: relative;
        }
        .tile > img {
            width: 1.1cm;
        }
        .tile.selected {
            outline: 3px solid #800;
        }
        div.row {
            text-align: center;
            margin: .2cm 0;
        }
        p.caption {
            text-align: center;
            font-weight: bold;
            text-decoration: underline;
            margin: .5cm 0 .2cm;
        }
        ul {
            margin: 0 0 .5cm;
        }
        ul.first {
            margin-top: .5cm;
        }
        li {
            margin: .15cm 0;
        }
        .cycle-buttons {
            margin: 1em 0 0;
        }
        span.indicate {
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translate(-50%, 2px);
        }
    </style>
    <script>
        var _tiles = "Bamboo 2,Plum,Green Dragon,Spring,Bamboo 3,Winter,Bamboo,Bamboo 4,Bamboo 5,Bamboo 6,Bamboo 7,Bamboo 8,Summer,Bamboo 9,Bamboo 1,Char 1,Char 2,Orchid,Fall,Char 3,West,Char 4,Char 5,Char 6,Char 7,Char 8,Char 9,Wheel 1,Wheel 2,Wheel 3,Chrysanthemum,Wheel 4,Wheel 5,Wheel 6,Wheel 7,Wheel 8,Wheel 9,East,South,Red Dragon,White Dragon,North".split(',');

        function abbrev(name)
        {
            if (m = /^(\w)\w+ (\w|\d)\w*$/.exec(name))
                return m[1]+m[2];
            return name.substr(0, 2);
        }

        function setDefaultRules(rnd) { setRules(rnd); }
        function setRules(rnd)
        {
            var skip = rnd.next(0, 100);
            for (var i = 0; i < skip; i++)
                rnd.nextDouble();

            var tiles = _tiles.slice(0);
            rnd.shuffleFisherYates(tiles);

            var elems = document.getElementsByClassName('tile');
            for (var i = 0; i < 42; i++)
            {
                elems[i].firstChild.setAttribute('src', `img/Mahjong/${tiles[i]}.png`);
                elems[i].firstChild.setAttribute('alt', abbrev(tiles[i]));
                elems[i].setAttribute('title', `${tiles[i]}`);
            }
        }
    </script>
</head>
<body>
<div class="section">
    <div class="page page-bg-04">
        <div class="page-header">
            <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
            <span class="page-header-section-title">Mahjong</span>
        </div>
        <div class="page-content">
            <img src="img/Component/Mahjong.svg" class="diagram">
            <h2>On the Subject of Mahjong</h2>
            <p class="flavour-text">Plum, Orchid, Chrysanthemum, Bamboo. Remember that.</p>

            <ul class="first">
                <li>Take the first character of the serial number. If it’s a letter, take its alphabetic position and add 9. If this is not in the range 0–13, subtract 14 until it is.</li>
                <li>Find the Mahjong tile in that position in the first Match Row below, counting from 0.</li>
                <li>Perform the same calculation with the second character of the serial number and find the corresponding Mahjong tile in the second Match Row.</li>
                <li>Swap those two tiles.</li>
                <li>Do the same again with the third and fourth character, then once more with the fifth and sixth.</li>
            </ul>

            <p class="caption">Match Rows</p>
            <div class="row">
                <span class="tile highlightable" title="Char 1"><img src="img/Mahjong/Char 1.png"><span class='indicate'>0</span></span>
                <span class="tile highlightable" title="Bamboo 5"><img src="img/Mahjong/Bamboo 5.png"></span>
                <span class="tile highlightable" title="Wheel 5"><img src="img/Mahjong/Wheel 5.png"></span>
                <span class="tile highlightable" title="Bamboo 8"><img src="img/Mahjong/Bamboo 8.png"></span>
                <span class="tile highlightable" title="Bamboo 2"><img src="img/Mahjong/Bamboo 2.png"></span>
                <span class="tile highlightable" title="Char 9"><img src="img/Mahjong/Char 9.png"><span class='indicate'>5</span></span>
                <span class="tile highlightable" title="Red Dragon"><img src="img/Mahjong/Red Dragon.png"></span>
                <span class="tile highlightable" title="Bamboo 6"><img src="img/Mahjong/Bamboo 6.png"></span>
                <span class="tile highlightable" title="Bamboo 4"><img src="img/Mahjong/Bamboo 4.png"></span>
                <span class="tile highlightable" title="Wheel 4"><img src="img/Mahjong/Wheel 4.png"></span>
                <span class="tile highlightable" title="Char 6"><img src="img/Mahjong/Char 6.png"><span class='indicate'>10</span></span>
                <span class="tile highlightable" title="Char 2"><img src="img/Mahjong/Char 2.png"></span>
                <span class="tile highlightable" title="Wheel 2"><img src="img/Mahjong/Wheel 2.png"></span>
                <span class="tile highlightable" title="Char 3"><img src="img/Mahjong/Char 3.png"></span>
            </div>
            <div class="row shiftable">
                <span class="tile highlightable" title="Wheel 9"><img src="img/Mahjong/Wheel 9.png"></span>
                <span class="tile highlightable" title="Wheel 1"><img src="img/Mahjong/Wheel 1.png"></span>
                <span class="tile highlightable" title="Char 8"><img src="img/Mahjong/Char 8.png"></span>
                <span class="tile highlightable" title="Wheel 7"><img src="img/Mahjong/Wheel 7.png"></span>
                <span class="tile highlightable" title="Bamboo 9"><img src="img/Mahjong/Bamboo 9.png"></span>
                <span class="tile highlightable" title="Bamboo 7"><img src="img/Mahjong/Bamboo 7.png"></span>
                <span class="tile highlightable" title="Char 7"><img src="img/Mahjong/Char 7.png"></span>
                <span class="tile highlightable" title="White Dragon"><img src="img/Mahjong/White Dragon.png"></span>
                <span class="tile highlightable" title="Char 4"><img src="img/Mahjong/Char 4.png"></span>
                <span class="tile highlightable" title="Bamboo 3"><img src="img/Mahjong/Bamboo 3.png"></span>
                <span class="tile highlightable" title="Wheel 8"><img src="img/Mahjong/Wheel 8.png"></span>
                <span class="tile highlightable" title="Wheel 3"><img src="img/Mahjong/Wheel 3.png"></span>
                <span class="tile highlightable" title="Wheel 6"><img src="img/Mahjong/Wheel 6.png"></span>
                <span class="tile highlightable" title="Char 5"><img src="img/Mahjong/Char 5.png"></span>
                <div class='cycle-buttons'>
                    <button id="cycle-left">←</button>
                    <button id="cycle-right">→</button>
                </div>
            </div>

            <ul>
                <li>Identify the extra tile in the bottom-left corner of the module and determine its position in the Counting Row below, counting from 0.</li>
                <li>Cycle the bottom Match Row to the right by that many tiles.</li>
            </ul>

            <p class="caption">Counting Row</p>
            <div class="row">
                <span class="tile highlightable" title="Bamboo 1"><img src="img/Mahjong/Bamboo 1.png"><span class='indicate'>0</span></span>
                <span class="tile highlightable" title="Plum"><img src="img/Mahjong/Plum.png"></span>
                <span class="tile highlightable" title="Orchid"><img src="img/Mahjong/Orchid.png"></span>
                <span class="tile highlightable" title="Chrysanthemum"><img src="img/Mahjong/Chrysanthemum.png"></span>
                <span class="tile highlightable" title="Bamboo"><img src="img/Mahjong/Bamboo.png"></span>
                <span class="tile highlightable" title="Spring"><img src="img/Mahjong/Spring.png"><span class='indicate'>5</span></span>
                <span class="tile highlightable" title="Summer"><img src="img/Mahjong/Summer.png"></span>
                <span class="tile highlightable" title="Fall"><img src="img/Mahjong/Fall.png"></span>
                <span class="tile highlightable" title="Winter"><img src="img/Mahjong/Winter.png"></span>
                <span class="tile highlightable" title="North"><img src="img/Mahjong/North.png"></span>
                <span class="tile highlightable" title="East"><img src="img/Mahjong/East.png"><span class='indicate'>10</span></span>
                <span class="tile highlightable" title="South"><img src="img/Mahjong/South.png"></span>
                <span class="tile highlightable" title="West"><img src="img/Mahjong/West.png"></span>
                <span class="tile highlightable" title="Green Dragon"><img src="img/Mahjong/Green Dragon.png"></span>
            </div>

            <ul>
                <li>On the module, a tile is “<em>available</em>” if either its left or its right edge has no tile adjacent to it, and no tile is (even partially) on top of it.</li>
                <li>Select pairs of <em>available</em> tiles on the module whose likenesses are vertically aligned in the modified Match Rows.</li>
                <li>A correct pair disappears. An incorrect pair incurs a strike.</li>
                <li>Once all tiles are eliminated, the module is disarmed.</li>
            </ul>
        </div>
        <div class="page-footer relative-footer">Page 1 of 1</div>
    </div>
    <script>
        var tiles = document.getElementsByClassName('tile');
        var selectedTile = null;
        for (var tileIx = 0; tileIx < tiles.length; tileIx++)
        {
            (function(i)
            {
                tiles[i].onclick = function()
                {
                    if (selectedTile === null)
                    {
                        selectedTile = i;
                        tiles[i].classList.add('selected');
                    }
                    else if (selectedTile === i)
                    {
                        selectedTile = null;
                        tiles[i].classList.remove('selected');
                    }
                    else
                    {
                        tiles[selectedTile].classList.remove('selected');
                        var imgSrc = tiles[i].firstChild.src;
                        var title = tiles[i].getAttribute('title');
                        tiles[i].firstChild.src = tiles[selectedTile].firstChild.src;
                        tiles[i].setAttribute('title', tiles[selectedTile].getAttribute('title'));
                        tiles[selectedTile].firstChild.src = imgSrc;
                        tiles[selectedTile].setAttribute('title', title);
                        selectedTile = null;
                    }
                };
            })(tileIx);
        }

        function cycleHandler(offset)
        {
            return function()
            {
                var infs = Array.from(tiles).map(tile => ({ title: tile.getAttribute('title'), imgSrc: tile.firstChild.src }));
                console.log(infs);
                var cutOut = infs.splice(28-offset, offset);
                console.log(infs);
                console.log(cutOut);
                infs.splice(14, 0, ...cutOut);
                console.log(infs);
                for (var i = 0; i < infs.length; i++)
                {
                    tiles[i].firstChild.src = infs[i].imgSrc;
                    tiles[i].setAttribute('title', infs[i].title);
                }
            }
        }
        document.getElementById('cycle-left').onclick = cycleHandler(13);
        document.getElementById('cycle-right').onclick = cycleHandler(1);
    </script>
</div>
</body>
</html>
