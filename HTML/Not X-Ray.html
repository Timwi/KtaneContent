<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Not X-Ray — Keep Talking and Nobody Explodes Mod</title>
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/ktane-utils.js"></script>
    <script src='js/ruleseed.js'></script>
    <style>
        .icon {
            display: block;
            width: .9cm;
            height: .9cm;
            background-size: 9.9cm 9cm;
            background-repeat: no-repeat;
            background-image: url('img/X-Ray/Icons.svg');
        }
        .icon.flipped { transform: scaleY(-1); }
        .icon.a1 { background-position: 0cm 0cm; }
        .icon.b1 { background-position: -0.9cm 0cm; }
        .icon.c1 { background-position: -1.8cm 0cm; }
        .icon.d1 { background-position: -2.7cm 0cm; }
        .icon.e1 { background-position: -3.6cm 0cm; }
        .icon.f1 { background-position: -4.5cm 0cm; }
        .icon.g1 { background-position: -5.4cm 0cm; }
        .icon.h1 { background-position: -6.3cm 0cm; }
        .icon.i1 { background-position: -7.2cm 0cm; }
        .icon.j1 { background-position: -8.1cm 0cm; }
        .icon.k1 { background-position: -9cm 0cm; }
        .icon.a2 { background-position: 0cm -0.9cm; }
        .icon.b2 { background-position: -0.9cm -0.9cm; }
        .icon.c2 { background-position: -1.8cm -0.9cm; }
        .icon.d2 { background-position: -2.7cm -0.9cm; }
        .icon.e2 { background-position: -3.6cm -0.9cm; }
        .icon.f2 { background-position: -4.5cm -0.9cm; }
        .icon.g2 { background-position: -5.4cm -0.9cm; }
        .icon.h2 { background-position: -6.3cm -0.9cm; }
        .icon.i2 { background-position: -7.2cm -0.9cm; }
        .icon.j2 { background-position: -8.1cm -0.9cm; }
        .icon.k2 { background-position: -9cm -0.9cm; }
        .icon.a3 { background-position: 0cm -1.8cm; }
        .icon.b3 { background-position: -0.9cm -1.8cm; }
        .icon.c3 { background-position: -1.8cm -1.8cm; }
        .icon.d3 { background-position: -2.7cm -1.8cm; }
        .icon.e3 { background-position: -3.6cm -1.8cm; }
        .icon.f3 { background-position: -4.5cm -1.8cm; }
        .icon.g3 { background-position: -5.4cm -1.8cm; }
        .icon.h3 { background-position: -6.3cm -1.8cm; }
        .icon.i3 { background-position: -7.2cm -1.8cm; }
        .icon.j3 { background-position: -8.1cm -1.8cm; }
        .icon.k3 { background-position: -9cm -1.8cm; }
        .icon.a4 { background-position: 0cm -2.7cm; }
        .icon.b4 { background-position: -0.9cm -2.7cm; }
        .icon.c4 { background-position: -1.8cm -2.7cm; }
        .icon.d4 { background-position: -2.7cm -2.7cm; }
        .icon.e4 { background-position: -3.6cm -2.7cm; }
        .icon.f4 { background-position: -4.5cm -2.7cm; }
        .icon.g4 { background-position: -5.4cm -2.7cm; }
        .icon.h4 { background-position: -6.3cm -2.7cm; }
        .icon.i4 { background-position: -7.2cm -2.7cm; }
        .icon.j4 { background-position: -8.1cm -2.7cm; }
        .icon.k4 { background-position: -9cm -2.7cm; }
        .icon.a5 { background-position: 0cm -3.6cm; }
        .icon.b5 { background-position: -0.9cm -3.6cm; }
        .icon.c5 { background-position: -1.8cm -3.6cm; }
        .icon.d5 { background-position: -2.7cm -3.6cm; }
        .icon.e5 { background-position: -3.6cm -3.6cm; }
        .icon.f5 { background-position: -4.5cm -3.6cm; }
        .icon.g5 { background-position: -5.4cm -3.6cm; }
        .icon.h5 { background-position: -6.3cm -3.6cm; }
        .icon.i5 { background-position: -7.2cm -3.6cm; }
        .icon.j5 { background-position: -8.1cm -3.6cm; }
        .icon.k5 { background-position: -9cm -3.6cm; }
        .icon.a6 { background-position: 0cm -4.5cm; }
        .icon.b6 { background-position: -0.9cm -4.5cm; }
        .icon.c6 { background-position: -1.8cm -4.5cm; }
        .icon.d6 { background-position: -2.7cm -4.5cm; }
        .icon.e6 { background-position: -3.6cm -4.5cm; }
        .icon.f6 { background-position: -4.5cm -4.5cm; }
        .icon.g6 { background-position: -5.4cm -4.5cm; }
        .icon.h6 { background-position: -6.3cm -4.5cm; }
        .icon.i6 { background-position: -7.2cm -4.5cm; }
        .icon.j6 { background-position: -8.1cm -4.5cm; }
        .icon.k6 { background-position: -9cm -4.5cm; }
        .icon.a7 { background-position: 0cm -5.4cm; }
        .icon.b7 { background-position: -0.9cm -5.4cm; }
        .icon.c7 { background-position: -1.8cm -5.4cm; }
        .icon.d7 { background-position: -2.7cm -5.4cm; }
        .icon.e7 { background-position: -3.6cm -5.4cm; }
        .icon.f7 { background-position: -4.5cm -5.4cm; }
        .icon.g7 { background-position: -5.4cm -5.4cm; }
        .icon.h7 { background-position: -6.3cm -5.4cm; }
        .icon.i7 { background-position: -7.2cm -5.4cm; }
        .icon.j7 { background-position: -8.1cm -5.4cm; }
        .icon.k7 { background-position: -9cm -5.4cm; }
        .icon.a8 { background-position: 0cm -6.3cm; }
        .icon.b8 { background-position: -0.9cm -6.3cm; }
        .icon.c8 { background-position: -1.8cm -6.3cm; }
        .icon.d8 { background-position: -2.7cm -6.3cm; }
        .icon.e8 { background-position: -3.6cm -6.3cm; }
        .icon.f8 { background-position: -4.5cm -6.3cm; }
        .icon.g8 { background-position: -5.4cm -6.3cm; }
        .icon.h8 { background-position: -6.3cm -6.3cm; }
        .icon.i8 { background-position: -7.2cm -6.3cm; }
        .icon.j8 { background-position: -8.1cm -6.3cm; }
        .icon.k8 { background-position: -9cm -6.3cm; }
        .icon.a9 { background-position: 0cm -7.2cm; }
        .icon.b9 { background-position: -0.9cm -7.2cm; }
        .icon.c9 { background-position: -1.8cm -7.2cm; }
        .icon.d9 { background-position: -2.7cm -7.2cm; }
        .icon.e9 { background-position: -3.6cm -7.2cm; }
        .icon.f9 { background-position: -4.5cm -7.2cm; }
        .icon.g9 { background-position: -5.4cm -7.2cm; }
        .icon.h9 { background-position: -6.3cm -7.2cm; }
        .icon.i9 { background-position: -7.2cm -7.2cm; }
        .icon.j9 { background-position: -8.1cm -7.2cm; }
        .icon.k9 { background-position: -9cm -7.2cm; }
        .icon.a10 { background-position: 0cm -8.1cm; }
        .icon.b10 { background-position: -0.9cm -8.1cm; }
        .icon.c10 { background-position: -1.8cm -8.1cm; }
        .icon.d10 { background-position: -2.7cm -8.1cm; }
        .icon.e10 { background-position: -3.6cm -8.1cm; }
        .icon.f10 { background-position: -4.5cm -8.1cm; }
        .icon.g10 { background-position: -5.4cm -8.1cm; }
        .icon.h10 { background-position: -6.3cm -8.1cm; }
        .icon.i10 { background-position: -7.2cm -8.1cm; }
        .icon.j10 { background-position: -8.1cm -8.1cm; }
        .icon.k10 { background-position: -9cm -8.1cm; }

        .dark table, table {
            border: none;
            margin: .2cm auto;
        }
        .dark .icon { filter: invert(90%); }
        td {
            padding: .1cm;
            text-align: center;
            font-size: 18pt;
            font-weight: bold;
            border: 1px solid #aaa;
        }
        .dark td { border: 1px solid #555; }
        td.center {
            background: #ddd;
            padding: .4em .6em 0;
        }
        .dark td.center { background: #444; }

        ul { padding-left: 1em; margin-bottom: 1cm; }
            li { margin: .3cm 0; }

        .not-xray-wrap {
            display: flex;
            flex-wrap: wrap;
        }

        .not-xray-table tr:first-child td:not(.corner), .not-xray-table tr:nth-child(2) td:first-child, .not-xray-table tr:nth-child(2) td:last-child {
            border-top: 3px solid;
        }
        .not-xray-table tr:not(:first-child):not(:last-child) td:first-child,
        .not-xray-table tr:first-child td:nth-child(2),
        .not-xray-table tr:last-child td:nth-child(2) {
            border-left: 3px solid;
        }

        .not-xray-table td.wall-r { border-right: 3px solid; }
        .not-xray-table td.wall-d { border-bottom: 3px solid; }
    </style>
    <script>
        function setDefaultRules(rnd) { setRules(rnd); }
        function setRules(rnd)
        {
            let sqs = Array(49).fill(null).map((_, c) => c).filter(c => c != 0 && c != 6 && c != 42 && c != 48 && c != 24);

            // First 55 symbols can be flipped, next 55 cannot
            const numFlippable = 55;
            const numUnflippable = 55;
            let unflippableSymbols = rnd.shuffleFisherYates(Array(numUnflippable).fill(null).map((_, c) => numFlippable + c));
            let flippableSymbols = rnd.shuffleFisherYates(Array(numFlippable).fill(null).map((_, c) => c));

            function x(c) { return c % 7; }
            function y(c) { return (c / 7) | 0; }

            let combinations = [];
            for (let ai = 0; ai < sqs.length; ai++)
                for (let bi = ai + 1; bi < sqs.length; bi++)
                    if (y(sqs[bi]) > y(sqs[ai]) && x(sqs[bi]) < x(sqs[ai]))
                        for (let ci = ai + 1; ci < sqs.length; ci++)
                            if (ci !== bi && y(sqs[ci]) > y(sqs[ai]) && x(sqs[ci]) > x(sqs[ai]) && x(sqs[ci]) > x(sqs[bi]))
                                for (let di = Math.max(bi, ci) + 1; di < sqs.length; di++)
                                    if (y(sqs[di]) > y(sqs[bi]) && y(sqs[di]) > y(sqs[ci]) && x(sqs[di]) > x(sqs[bi]) && x(sqs[di]) < x(sqs[ci]))
                                        combinations.push([sqs[ai], sqs[bi], sqs[ci], sqs[di]]);

            function generateTable(elem, symbols)
            {
                // generate maze

                let w = 7, h = 7;
                let notWalls = [];
                let todo = Array(49).fill(null).map((_, c) => c).filter(c => c != 0 && c != 6 && c != 42 && c != 48);
                let active = [];

                let start = rnd.next(0, todo.length);
                active.push(todo[start]);
                todo.splice(start, 1);

                while (todo.length > 0)
                {
                    let activeIx = rnd.next(0, active.length);
                    let sq = active[activeIx];
                    let adjs = [];
                    if ((sq % w) > 0 && todo.includes(sq - 1))
                        adjs.push(sq - 1);
                    if ((sq % w) < w - 1 && todo.includes(sq + 1))
                        adjs.push(sq + 1);
                    if (((sq / w) | 0) > 0 && todo.includes(sq - w))
                        adjs.push(sq - w);
                    if (((sq / w) | 0) < h - 1 && todo.includes(sq + w))
                        adjs.push(sq + w);

                    if (adjs.length == 0)
                    {
                        active.splice(activeIx, 1);
                        continue;
                    }
                    else
                    {
                        let adj = adjs[rnd.next(0, adjs.length)];
                        todo.splice(todo.indexOf(adj), 1);
                        active.push(adj);

                        if (adj === sq - 1)
                            notWalls.push({ cell: adj, right: true });
                        else if (adj === sq + 1)
                            notWalls.push({ cell: sq, right: true });
                        else if (adj === sq - w)
                            notWalls.push({ cell: adj, right: false });
                        else if (adj === sq + w)
                            notWalls.push({ cell: sq, right: false });
                    }
                }

                // generate symbol arrangements

                let backtracks = 0;
                function findArrangement(numSofar, combinationsLeft)
                {
                    if (numSofar === 11)
                        return [];
                    if (combinationsLeft.length === 0)
                        return null;

                    let offset = rnd.next(0, combinationsLeft.length);
                    for (let ir = 0; ir < combinationsLeft.length; ir++)
                    {
                        let i = (ir + offset) % combinationsLeft.length;
                        let combination = combinationsLeft[i];
                        let combLeft = combinationsLeft.filter(cmb => cmb.every(c => !combination.includes(c)));
                        let result = findArrangement(numSofar + 1, combLeft);
                        if (result !== null)
                        {
                            result.push(combination);
                            return result;
                        }
                        if (backtracks > 500)
                            return null;
                    }
                    backtracks++;
                    return null;
                }

                let arrangement;
                do {
                    backtracks = 0;
                    arrangement = findArrangement(0, combinations);
                }
                while (arrangement === null);

                // generate HTML table

                function symbolClass(sym)
                {
                    return `icon ${String.fromCharCode(97 + (sym.ix % 11))}${((sym.ix / 11) | 0) + 1}${sym.flip ? ' flipped' : ''}`;
                }

                function td(cell)
                {
                    if (cell === 0 || cell === 6 || cell === 42 || cell === 48)
                        return '<td class="corner"></td>';

                    let wallR = !notWalls.some(nw => nw.cell === cell && nw.right);
                    let wallD = !notWalls.some(nw => nw.cell === cell && !nw.right);
                    if (cell === 24)
                        return `<td class="center${wallR ? ' wall-r' : ''}${wallD ? ' wall-d' : ''}">?<${''}/td>`;

                    let arrIx = arrangement.findIndex(comb => comb.includes(cell));
                    return `<td class="cell${wallR ? ' wall-r' : ''}${wallD ? ' wall-d' : ''}"><div class='${symbolClass(symbols[arrIx])}'><${''}/div><${''}/td>`;
                }

                elem.innerHTML =
                    Array(7).fill(null).map((_, row) => `<tr>${
                        Array(7).fill(null).map((_, col) => td(col + 7*row)).join('')
                    }<${''}/tr>`).join('');
            }

            let tables = Array.from(document.getElementsByClassName('not-xray-table'));
            for (let tableIx = 0; tableIx < tables.length; tableIx++)
                generateTable(tables[tableIx], [
                    ...flippableSymbols.slice(tableIx * 4, tableIx * 4 + 4).map(s => ({ ix: s, flip: false })),
                    ...flippableSymbols.slice(tableIx * 4, tableIx * 4 + 4).map(s => ({ ix: s, flip: true })),
                    ...unflippableSymbols.slice(tableIx * 3, tableIx * 3 + 3).map(s => ({ ix: s, flip: false }))]);
        }
    </script>
</head>
<body>
    <div class="section">
        <div class="page page-bg-02">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Not X-Ray</span>
            </div>
            <div class="page-content">
                <img src="img/Component/X-Ray.svg" class="diagram">

                <h2>On the Subject of Not X-Rays</h2>
                <p class='flavour-text'>You can’t hear left around me.</p>

                <ul>
                    <li>A symbol is revealed in the window by an x-ray scanner. The scanner shows a thin section of the symbol. If there are multiple symbols, you are looking at a different module.</li>
                    <li>The symbol corresponds to your position in one of the eight grids below. Press the buttons labeled 1, 2, 3 and 4 at will to move orthogonally within the grid and determine which button moves in which direction. The symbol appearing in the scanner will change to reflect your new position. The grid wraps around both horizontally and vertically.</li>
                    <li>Travel to the center of the grid. The scanner will show your goal symbol. If the last button pressed was even, the symbol is scanned top to bottom, otherwise bottom to top. Press 5 on this space and observe the scanner’s new color.</li>
                    <li>From now on, do not cross the thick lines in the grid.</li>
                    <li>Find the goal symbol in the grid. If the scanner color is red, travel to the topmost occurrence of the symbol; for yellow, rightmost; blue, bottommost; and white, leftmost. Rotations and reflections are not considered the same symbol.</li>
                    <li>When you are on the correct space, press 5 again to disarm the module.</li>
                </ul>

                <div class='not-xray-wrap'>
                    <table class="not-xray-table"></table>
                    <table class="not-xray-table"></table>
                </div>
            </div>
            <div class="page-footer relative-footer">Page 1 of 2</div>
        </div>
        <div class="page page-bg-01">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Not X-Ray</span>
            </div>
            <div class="page-content">
                <div class='not-xray-wrap'>
                    <table class="not-xray-table"></table>
                    <table class="not-xray-table"></table>
                    <table class="not-xray-table"></table>
                    <table class="not-xray-table"></table>
                    <table class="not-xray-table"></table>
                    <table class="not-xray-table"></table>
                </div>
            </div>
            <div class="page-footer relative-footer">Page 2 of 2</div>
        </div>
    </div>
</body>
</html>
